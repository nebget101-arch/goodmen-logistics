name: K6 Performance Tests

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - load
          - stress
          - spike
          - soak
          - all
      # Smoke Test Parameters
      smoke_vus:
        description: 'Smoke Test: Virtual Users'
        required: false
        default: '1'
      smoke_duration:
        description: 'Smoke Test: Duration (e.g., 30s, 1m)'
        required: false
        default: '30s'
      # Load Test Parameters
      load_ramp_up:
        description: 'Load Test: Ramp up time (e.g., 2m, 5m)'
        required: false
        default: '2m'
      load_steady:
        description: 'Load Test: Steady state time (e.g., 5m, 10m)'
        required: false
        default: '5m'
      load_target_vu1:
        description: 'Load Test: Target VU Level 1'
        required: false
        default: '10'
      load_target_vu2:
        description: 'Load Test: Target VU Level 2'
        required: false
        default: '20'
      load_target_vu3:
        description: 'Load Test: Target VU Level 3'
        required: false
        default: '30'
      # Stress Test Parameters
      stress_ramp_time:
        description: 'Stress Test: Ramp time between levels'
        required: false
        default: '2m'
      stress_steady_time:
        description: 'Stress Test: Steady time at each level'
        required: false
        default: '5m'
      stress_recovery_time:
        description: 'Stress Test: Recovery time'
        required: false
        default: '5m'
      stress_target_vu1:
        description: 'Stress Test: Normal load VUs'
        required: false
        default: '20'
      stress_target_vu2:
        description: 'Stress Test: Above normal VUs'
        required: false
        default: '50'
      stress_target_vu3:
        description: 'Stress Test: Stress level VUs'
        required: false
        default: '100'
      stress_target_vu4:
        description: 'Stress Test: Breaking point VUs'
        required: false
        default: '150'
      # Spike Test Parameters
      spike_normal_vu:
        description: 'Spike Test: Normal load VUs'
        required: false
        default: '5'
      spike_peak_vu:
        description: 'Spike Test: Peak spike VUs'
        required: false
        default: '100'
      spike_up_time:
        description: 'Spike Test: Time to spike (e.g., 30s)'
        required: false
        default: '30s'
      spike_sustain_time:
        description: 'Spike Test: Sustain spike duration'
        required: false
        default: '3m'
      spike_down_time:
        description: 'Spike Test: Time to return to normal'
        required: false
        default: '30s'
      spike_recovery_time:
        description: 'Spike Test: Recovery period'
        required: false
        default: '2m'
      # Soak Test Parameters
      soak_vus:
        description: 'Soak Test: Virtual Users'
        required: false
        default: '20'
      soak_duration:
        description: 'Soak Test: Duration (e.g., 1h, 30m)'
        required: false
        default: '1h'
      # Vehicles Test Parameters
      vehicles_ramp_up:
        description: 'Vehicles Test: Ramp up time'
        required: false
        default: '30s'
      vehicles_steady:
        description: 'Vehicles Test: Steady state time'
        required: false
        default: '1m'
      vehicles_ramp_down:
        description: 'Vehicles Test: Ramp down time'
        required: false
        default: '20s'
      vehicles_target_vu:
        description: 'Vehicles Test: Target VUs'
        required: false
        default: '10'

jobs:
  k6-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: k6-performance-tests/package-lock.json

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Install dependencies
        working-directory: k6-performance-tests
        run: npm ci

      - name: Wait for deployment to be ready
        run: |
          echo "Waiting for https://safetyapp-ln58.onrender.com to be ready..."
          for i in {1..30}; do
            if curl -sf https://safetyapp-ln58.onrender.com/api/health > /dev/null; then
              echo "‚úÖ Application is ready!"
              exit 0
            fi
            echo "Attempt $i/30: Not ready yet, waiting 10s..."
            sleep 10
          done
          echo "‚ùå Application failed to respond"
          exit 1

      - name: Run K6 tests
        working-directory: k6-performance-tests
        env:
          # Smoke test parameters
          VUS: ${{ github.event.inputs.smoke_vus }}
          DURATION: ${{ github.event.inputs.smoke_duration }}
          # Load test parameters
          RAMP_UP_TIME: ${{ github.event.inputs.load_ramp_up }}
          STEADY_TIME: ${{ github.event.inputs.load_steady }}
          TARGET_VU_1: ${{ github.event.inputs.load_target_vu1 }}
          TARGET_VU_2: ${{ github.event.inputs.load_target_vu2 }}
          TARGET_VU_3: ${{ github.event.inputs.load_target_vu3 }}
          # Stress test parameters
          STRESS_RAMP_TIME: ${{ github.event.inputs.stress_ramp_time }}
          STRESS_STEADY_TIME: ${{ github.event.inputs.stress_steady_time }}
          STRESS_RECOVERY_TIME: ${{ github.event.inputs.stress_recovery_time }}
          STRESS_TARGET_VU_1: ${{ github.event.inputs.stress_target_vu1 }}
          STRESS_TARGET_VU_2: ${{ github.event.inputs.stress_target_vu2 }}
          STRESS_TARGET_VU_3: ${{ github.event.inputs.stress_target_vu3 }}
          STRESS_TARGET_VU_4: ${{ github.event.inputs.stress_target_vu4 }}
          # Spike test parameters
          SPIKE_NORMAL_VU: ${{ github.event.inputs.spike_normal_vu }}
          SPIKE_PEAK_VU: ${{ github.event.inputs.spike_peak_vu }}
          SPIKE_UP_TIME: ${{ github.event.inputs.spike_up_time }}
          SPIKE_SUSTAIN_TIME: ${{ github.event.inputs.spike_sustain_time }}
          SPIKE_DOWN_TIME: ${{ github.event.inputs.spike_down_time }}
          SPIKE_RECOVERY_TIME: ${{ github.event.inputs.spike_recovery_time }}
          # Soak test parameters
          SOAK_VUS: ${{ github.event.inputs.soak_vus }}
          SOAK_DURATION: ${{ github.event.inputs.soak_duration }}
          # Vehicles test parameters
          VEHICLES_RAMP_UP: ${{ github.event.inputs.vehicles_ramp_up }}
          VEHICLES_STEADY: ${{ github.event.inputs.vehicles_steady }}
          VEHICLES_RAMP_DOWN: ${{ github.event.inputs.vehicles_ramp_down }}
          VEHICLES_TARGET_VU: ${{ github.event.inputs.vehicles_target_vu }}
        run: |
          echo "Running ${{ github.event.inputs.test_type }} test..."
          case "${{ github.event.inputs.test_type }}" in
            smoke)
              echo "üìä Smoke Test Configuration:"
              echo "  VUs: ${VUS:-1}"
              echo "  Duration: ${DURATION:-30s}"
              npm run test:smoke
              ;;
            load)
              echo "üìä Load Test Configuration:"
              echo "  Ramp Up: ${RAMP_UP_TIME:-2m}"
              echo "  Steady Time: ${STEADY_TIME:-5m}"
              echo "  Target VU Levels: ${TARGET_VU_1:-10} ‚Üí ${TARGET_VU_2:-20} ‚Üí ${TARGET_VU_3:-30}"
              npm run test:load
              ;;
            stress)
              echo "üìä Stress Test Configuration:"
              echo "  Ramp Time: ${STRESS_RAMP_TIME:-2m}"
              echo "  Steady Time: ${STRESS_STEADY_TIME:-5m}"
              echo "  Recovery: ${STRESS_RECOVERY_TIME:-5m}"
              echo "  Target VU Levels: ${STRESS_TARGET_VU_1:-20} ‚Üí ${STRESS_TARGET_VU_2:-50} ‚Üí ${STRESS_TARGET_VU_3:-100} ‚Üí ${STRESS_TARGET_VU_4:-150}"
              npm run test:stress
              ;;
            spike)
              echo "üìä Spike Test Configuration:"
              echo "  Normal VUs: ${SPIKE_NORMAL_VU:-5}"
              echo "  Peak VUs: ${SPIKE_PEAK_VU:-100}"
              echo "  Spike Up: ${SPIKE_UP_TIME:-30s}"
              echo "  Sustain: ${SPIKE_SUSTAIN_TIME:-3m}"
              npm run test:spike
              ;;
            soak)
              echo "üìä Soak Test Configuration:"
              echo "  VUs: ${SOAK_VUS:-20}"
              echo "  Duration: ${SOAK_DURATION:-1h}"
              npm run test:soak
              ;;
            all)
              echo "üìä Running all tests with configured parameters"
              npm run test:all
              ;;
          esac

      - name: Cleanup test data
        if: always()
        working-directory: k6-performance-tests
        run: |
          echo "Cleaning up test data..."
          npm run cleanup

      - name: Generate performance reports
        if: always()
        working-directory: k6-performance-tests
        run: |
          echo "Generating performance reports..."
          npm run report || echo "Report generation completed"

      - name: Upload test results as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-performance-results-${{ github.event.inputs.test_type }}-${{ github.run_number }}
          path: |
            k6-performance-tests/reports/*.json
            k6-performance-tests/reports/*.html
            k6-performance-tests/reports/*.md
          retention-days: 30

      - name: Parse test results
        if: always()
        id: parse-results
        working-directory: k6-performance-tests
        run: |
          # Try to find the most recent summary JSON file
          SUMMARY_FILE=$(ls -t reports/*summary.json 2>/dev/null | head -1)
          
          if [ -f "$SUMMARY_FILE" ]; then
            echo "Found summary file: $SUMMARY_FILE"
            TOTAL_REQUESTS=$(jq -r '.totalRequests // "N/A"' "$SUMMARY_FILE")
            FAILED_REQUESTS=$(jq -r '.failedRequests // 0' "$SUMMARY_FILE")
            AVG_RESPONSE=$(jq -r '.avgResponseTime // "N/A"' "$SUMMARY_FILE")
            P95_RESPONSE=$(jq -r '.p95ResponseTime // "N/A"' "$SUMMARY_FILE")
            PASSED=$(jq -r '.passed // false' "$SUMMARY_FILE")
            
            echo "total_requests=$TOTAL_REQUESTS" >> $GITHUB_OUTPUT
            echo "failed_requests=$FAILED_REQUESTS" >> $GITHUB_OUTPUT
            echo "avg_response=$AVG_RESPONSE" >> $GITHUB_OUTPUT
            echo "p95_response=$P95_RESPONSE" >> $GITHUB_OUTPUT
            echo "test_passed=$PASSED" >> $GITHUB_OUTPUT
            echo "has_results=true" >> $GITHUB_OUTPUT
          else
            echo "No summary file found, will use basic results"
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

      - name: Post results to GitHub
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const testType = '${{ github.event.inputs.test_type }}';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const hasResults = '${{ steps.parse-results.outputs.has_results }}' === 'true';
            const jobStatus = '${{ job.status }}';
            
            let resultsBody = `## üöÄ K6 Performance Test Results
            
            **Test Type:** ${testType.toUpperCase()}
            **Triggered by:** @${{ github.actor }}
            **Status:** ${jobStatus === 'success' ? '‚úÖ Completed' : '‚ùå Failed'}
            **Run:** [#${{ github.run_number }}](${runUrl})
            
            `;
            
            if (hasResults) {
              const totalRequests = '${{ steps.parse-results.outputs.total_requests }}';
              const failedRequests = '${{ steps.parse-results.outputs.failed_requests }}';
              const avgResponse = '${{ steps.parse-results.outputs.avg_response }}';
              const p95Response = '${{ steps.parse-results.outputs.p95_response }}';
              const testPassed = '${{ steps.parse-results.outputs.test_passed }}' === 'true';
              
              resultsBody += `### üìä Metrics Summary
              
              - **Total Requests:** ${totalRequests}
              - **Failed Requests:** ${failedRequests}
              - **Average Response Time:** ${avgResponse}ms
              - **95th Percentile:** ${p95Response}ms
              - **Test Status:** ${testPassed ? '‚úÖ Passed' : '‚ùå Failed'}
              
              `;
            } else {
              resultsBody += `### ‚ÑπÔ∏è Test Execution
              
              Test execution completed. Detailed metrics may not be available.
              
              `;
            }
            
            resultsBody += `### üì• Download Reports
            
            View and download detailed reports from the [Actions run page](${runUrl}).
            
            **Available Reports:**
            - JSON summary
            - HTML performance report
            - Markdown summary
            
            ---
            *Performance test completed at ${new Date().toISOString()}*
            `;
            
            // Create an issue comment with results
            try {
              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: resultsBody
              });
              console.log('‚úÖ Posted results as commit comment');
            } catch (error) {
              console.log('Could not post commit comment, posting as discussion instead');
              console.log(resultsBody);
            }

      - name: Fail if tests failed
        if: failure()
        run: |
          echo "‚ùå K6 performance tests failed"
          exit 1

