<div class="container">
  <div class="card">
    <!-- Card Header -->
    <div class="card-header">
      <h2 class="card-title" id="vehicles-title">
        <span aria-label="truck" role="img">üöõ</span> Vehicle Fleet Management
      </h2>
      <button 
        class="btn btn-primary" 
        (click)="openAddVehicleForm()"
        aria-label="Add new vehicle"
        type="button">
        + Add Vehicle
      </button>
    </div>

    <!-- Search and Filter Controls -->
    <div *ngIf="!loading && !error" class="controls-section">
      <div class="controls-row">
        <!-- Search Input -->
        <div class="control-group search-group">
          <label for="vehicle-search" class="control-label">
            <span aria-hidden="true">üîç</span> Search
          </label>
          <input
            id="vehicle-search"
            type="text"
            class="form-control search-input"
            placeholder="Search by unit #, plate, VIN, make/model..."
            [value]="searchQuery"
            (input)="onSearchInput($event)"
            aria-label="Search vehicles by unit number, plate, VIN, or make/model"
          />
        </div>

        <!-- Status Filter -->
        <div class="control-group filter-group">
          <label for="status-filter" class="control-label">
            <span aria-hidden="true">üìä</span> Status
          </label>
          <select
            id="status-filter"
            class="form-control filter-select"
            [(ngModel)]="selectedStatus"
            (change)="onStatusChange(selectedStatus)"
            aria-label="Filter vehicles by status"
          >
            <option *ngFor="let option of statusOptions" [value]="option.value">
              {{ option.label }}
            </option>
          </select>
        </div>

        <!-- Items Per Page -->
        <div class="control-group pagesize-group">
          <label for="page-size" class="control-label">
            <span aria-hidden="true">üìÑ</span> Show
          </label>
          <select
            id="page-size"
            class="form-control pagesize-select"
            [value]="itemsPerPage"
            (change)="onPageSizeChange(+$any($event.target).value)"
            aria-label="Items per page"
          >
            <option *ngFor="let size of pageSizeOptions" [value]="size">
              {{ size }} items
            </option>
          </select>
        </div>

        <!-- Clear Filters Button -->
        <button
          *ngIf="hasActiveFilters"
          class="btn btn-secondary clear-btn"
          (click)="clearFilters()"
          type="button"
          aria-label="Clear all filters"
        >
          <span aria-hidden="true">‚úï</span> Clear
        </button>
      </div>

      <!-- Results Summary -->
      <div class="results-summary" role="status" aria-live="polite">
        <span class="results-text">
          Showing {{ displayingRange }}
          <span *ngIf="hasActiveFilters" class="filtered-text">(filtered from {{ allVehicles.length }} total)</span>
        </span>
      </div>
    </div>

    <!-- Loading State with Skeleton -->
    <div *ngIf="loading" class="vehicles-loading" role="status" aria-live="polite" aria-label="Loading vehicles">
      <div class="skeleton-table">
        <div class="skeleton-header">
          <div class="skeleton-cell" *ngFor="let i of [1,2,3,4,5,6,7,8]"></div>
        </div>
        <div class="skeleton-row" *ngFor="let row of skeletonRows">
          <div class="skeleton-cell skeleton-pulse"></div>
          <div class="skeleton-cell skeleton-pulse"></div>
          <div class="skeleton-cell skeleton-pulse"></div>
          <div class="skeleton-cell skeleton-pulse"></div>
          <div class="skeleton-cell skeleton-pulse"></div>
          <div class="skeleton-cell skeleton-pulse"></div>
          <div class="skeleton-cell skeleton-pulse"></div>
          <div class="skeleton-cell skeleton-pulse"></div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div *ngIf="!loading && error" class="error-state" role="alert">
      <div class="error-icon" aria-hidden="true">‚ö†Ô∏è</div>
      <h3 class="error-title">Unable to Load Vehicles</h3>
      <p class="error-message">{{ error }}</p>
      <button 
        class="btn btn-primary retry-btn" 
        (click)="retryLoad()"
        type="button"
        aria-label="Retry loading vehicles">
        <span aria-hidden="true">üîÑ</span> Retry
      </button>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && !error && filteredVehicles.length === 0" class="empty-state">
      <div class="empty-icon" aria-hidden="true">üöõ</div>
      <h3 class="empty-title">{{ hasActiveFilters ? 'No Vehicles Match Your Search' : 'No Vehicles Found' }}</h3>
      <p class="empty-message">
        {{ hasActiveFilters ? 'Try adjusting your search or filter criteria.' : 'Your vehicle fleet is empty. Add your first vehicle to get started.' }}
      </p>
      <button 
        *ngIf="hasActiveFilters"
        class="btn btn-primary" 
        (click)="clearFilters()"
        type="button"
        aria-label="Clear all filters">
        Clear Filters
      </button>
      <button 
        *ngIf="!hasActiveFilters"
        class="btn btn-primary" 
        type="button"
        aria-label="Add your first vehicle">
        + Add Your First Vehicle
      </button>
    </div>

    <!-- Data Table -->
    <div *ngIf="!loading && !error && filteredVehicles.length > 0" class="table-responsive">
      <table class="table vehicles-table" aria-labelledby="vehicles-title">
        <thead>
          <tr>
            <th scope="col" class="sortable" (click)="onSortChange('unit_number')" role="button" tabindex="0" 
                (keydown.enter)="onSortChange('unit_number')" (keydown.space)="onSortChange('unit_number')"
                [attr.aria-sort]="sortField === 'unit_number' ? (sortOrder === 'asc' ? 'ascending' : 'descending') : 'none'">
              Unit # <span class="sort-icon" aria-hidden="true">{{ getSortIcon('unit_number') }}</span>
            </th>
            <th scope="col">Vehicle Details</th>
            <th scope="col">VIN</th>
            <th scope="col">Mileage</th>
            <th scope="col" class="sortable" (click)="onSortChange('inspection_expiry')" role="button" tabindex="0"
                (keydown.enter)="onSortChange('inspection_expiry')" (keydown.space)="onSortChange('inspection_expiry')"
                [attr.aria-sort]="sortField === 'inspection_expiry' ? (sortOrder === 'asc' ? 'ascending' : 'descending') : 'none'">
              Inspection Expires <span class="sort-icon" aria-hidden="true">{{ getSortIcon('inspection_expiry') }}</span>
            </th>
            <th scope="col">Next PM Due</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let vehicle of paginatedVehicles; trackBy: trackByVehicleId" 
              [class]="getWarningClass(vehicle)"
              (click)="openVehicleDetails(vehicle)"
              style="cursor: pointer;"
              [attr.aria-label]="'View details for vehicle ' + vehicle.unit_number">
            <td data-label="Unit #">
              <strong>{{ vehicle.unit_number }}</strong>
              <small class="vin-suffix">({{ vehicle.vin.slice(-4) }})</small>
            </td>
            <td data-label="Vehicle Details">
              <div class="vehicle-details">
                <span class="vehicle-info">{{ vehicle.year }} {{ vehicle.make }} {{ vehicle.model }}</span>
                <small class="vehicle-plate">{{ vehicle.license_plate }}</small>
              </div>
            </td>
            <td data-label="VIN">
              <small class="vin-text">{{ vehicle.vin }}</small>
            </td>
            <td data-label="Mileage">
              {{ vehicle.mileage.toLocaleString() }} mi
            </td>
            <td data-label="Inspection Expires">
              {{ vehicle.inspection_expiry | date: 'yyyy-MM-dd' }}
            </td>
            <td data-label="Next PM Due">
              <div class="pm-info">
                <span>{{ vehicle.next_pm_due | date: 'yyyy-MM-dd' }}</span>
                <small>&#64; {{ vehicle.next_pm_mileage.toLocaleString() }} mi</small>
              </div>
            </td>
            <td data-label="Status">
              <span 
                [class]="'badge ' + (isVehicleExpired(vehicle) ? 'badge-danger' : getStatusBadge(vehicle.status))"
                [attr.aria-label]="'Vehicle status: ' + (isVehicleExpired(vehicle) ? 'Out of Service - Expired Documents' : getStatusLabel(vehicle.status))">
                {{ isVehicleExpired(vehicle) ? 'Out of Service' : getStatusLabel(vehicle.status) }}
              </span>
              <div *ngIf="isVehicleExpired(vehicle) || vehicle.oos_reason" class="oos-reason" role="note">
                {{ isVehicleExpired(vehicle) ? 'Registration/Inspection Expired' : vehicle.oos_reason }}
              </div>
              <div *ngIf="getExpiryWarning(vehicle)" 
                   [class]="(getExpiryWarning(vehicle)?.includes('expired') || getExpiryWarning(vehicle)?.includes('overdue')) ? 'expiry-error' : 'expiry-warning'" 
                   role="alert">
                {{ (getExpiryWarning(vehicle)?.includes('expired') || getExpiryWarning(vehicle)?.includes('overdue')) ? 'üö´' : '‚ö†Ô∏è' }} {{ getExpiryWarning(vehicle) }}
              </div>
            </td>
            <td data-label="Actions">
              <button 
                class="btn btn-primary btn-sm" 
                type="button"
                (click)="openEditVehicleForm(vehicle)"
                [attr.aria-label]="'Edit vehicle ' + vehicle.unit_number">
                Edit
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <!-- Pagination Controls -->
    <div *ngIf="!loading && !error && filteredVehicles.length > 0" class="pagination-section">
      <div class="pagination-info">
        Showing {{ displayingRange }}
      </div>
      
      <nav class="pagination-nav" role="navigation" aria-label="Vehicles pagination">
        <button
          class="pagination-btn"
          [disabled]="currentPage === 1"
          (click)="onPageChange(currentPage - 1)"
          type="button"
          aria-label="Previous page"
        >
          ‚Äπ Prev
        </button>

        <button
          *ngFor="let page of getPageNumbers()"
          class="pagination-btn page-number"
          [class.active]="page === currentPage"
          [class.ellipsis]="page === -1"
          [disabled]="page === -1"
          (click)="page !== -1 && onPageChange(page)"
          type="button"
          [attr.aria-label]="page === -1 ? 'More pages' : 'Go to page ' + page"
          [attr.aria-current]="page === currentPage ? 'page' : null"
        >
          {{ page === -1 ? '...' : page }}
        </button>

        <button
          class="pagination-btn"
          [disabled]="currentPage === totalPages"
          (click)="onPageChange(currentPage + 1)"
          type="button"
          aria-label="Next page"
        >
          Next ‚Ä∫
        </button>
      </nav>
    </div>
  </div>

  <!-- Compliance Information -->
  <div class="card compliance-card">
    <div class="card-header">
      <h3 class="card-title">
        <span aria-label="clipboard" role="img">üìã</span> Maintenance Retention Requirements
      </h3>
    </div>
    <div class="compliance-content">
      <p>
        <strong>49 CFR 396.3:</strong> Maintenance records must be retained for 1 year where housed/maintained, 
        and for 6 months after the vehicle leaves the carrier's control.
      </p>
    </div>
  </div>
</div>

<!-- Vehicle Form Modal -->
<app-vehicle-form
  [isOpen]="showVehicleForm"
  [vehicle]="selectedVehicle"
  (close)="closeVehicleForm()"
  (save)="onVehicleSaved($event)">
</app-vehicle-form>

<!-- Vehicle Details Modal -->
<div class="modal-overlay" *ngIf="showVehicleDetails" (click)="closeVehicleDetails()" (keydown.escape)="closeVehicleDetails()" tabindex="-1">
  <div class="modal-container" (click)="$event.stopPropagation()" (keydown)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Vehicle Details</h2>
      <button class="close-btn" (click)="closeVehicleDetails()" type="button" aria-label="Close details">√ó</button>
    </div>
    
    <div class="modal-body" *ngIf="selectedVehicleDetails">
      <div class="details-grid">
        <!-- Basic Information -->
        <div class="detail-section">
          <h3 class="section-title">Basic Information</h3>
          <div class="detail-row">
            <span class="detail-label">Unit Number:</span>
            <span class="detail-value"><strong>{{ selectedVehicleDetails.unit_number }}</strong></span>
          </div>
          <div class="detail-row">
            <span class="detail-label">VIN:</span>
            <span class="detail-value">{{ selectedVehicleDetails.vin }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Vehicle:</span>
            <span class="detail-value">{{ selectedVehicleDetails.year }} {{ selectedVehicleDetails.make }} {{ selectedVehicleDetails.model }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">License Plate:</span>
            <span class="detail-value">{{ selectedVehicleDetails.license_plate }} ({{ selectedVehicleDetails.state }})</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Mileage:</span>
            <span class="detail-value">{{ selectedVehicleDetails.mileage.toLocaleString() }} miles</span>
          </div>
        </div>

        <!-- Status & Compliance -->
        <div class="detail-section">
          <h3 class="section-title">Status & Compliance</h3>
          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span [class]="'badge ' + getStatusBadge(selectedVehicleDetails.status)">
              {{ getStatusLabel(selectedVehicleDetails.status) }}
            </span>
          </div>
          <div class="detail-row" *ngIf="selectedVehicleDetails.oos_reason">
            <span class="detail-label">OOS Reason:</span>
            <span class="detail-value text-danger">{{ selectedVehicleDetails.oos_reason }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Inspection Expires:</span>
            <span class="detail-value">{{ selectedVehicleDetails.inspection_expiry | date: 'MMM dd, yyyy' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Registration Expires:</span>
            <span class="detail-value">{{ selectedVehicleDetails.registration_expiry | date: 'MMM dd, yyyy' }}</span>
          </div>
          <div class="detail-row" *ngIf="getExpiryWarning(selectedVehicleDetails)">
            <span class="detail-label">Warnings:</span>
            <span [class]="(getExpiryWarning(selectedVehicleDetails)?.includes('expired') || getExpiryWarning(selectedVehicleDetails)?.includes('overdue')) ? 'text-danger' : 'text-warning'">
              {{ getExpiryWarning(selectedVehicleDetails) }}
            </span>
          </div>
        </div>

        <!-- Maintenance -->
        <div class="detail-section">
          <h3 class="section-title">Maintenance</h3>
          <div class="detail-row">
            <span class="detail-label">Next PM Due:</span>
            <span class="detail-value">{{ selectedVehicleDetails.next_pm_due | date: 'MMM dd, yyyy' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Next PM Mileage:</span>
            <span class="detail-value">{{ selectedVehicleDetails.next_pm_mileage.toLocaleString() }} miles</span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn-secondary" (click)="closeVehicleDetails()" type="button">Close</button>
        <button class="btn btn-primary" (click)="openEditVehicleForm(selectedVehicleDetails); closeVehicleDetails()" type="button">
          Edit Vehicle
        </button>
      </div>
    </div>
  </div>
</div>
